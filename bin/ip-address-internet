#!/bin/sh

# get external IP addresses (IPv4 and IPv6)
# used for outgoing Internet connections

ipv4_only=false
ipv6_only=false
method="https"

# Parse arguments
for arg in "$@"; do
	case "$arg" in
		-4) ipv4_only=true ;;
		-6) ipv6_only=true ;;
		-h|--help)
			cat << 'EOF'
Usage: ip-address-internet [OPTIONS] [METHOD]

Print external IP addresses

Options:
  -4      IPv4 only
  -6      IPv6 only
  -h, --help  Show this help

Methods:
  https   HTTPS queries (default)
  http    HTTP queries
  dns     DNS queries via OpenDNS
EOF
			exit 0
			;;
		https|http|dns) method="$arg" ;;
		*) echo "Error: Unknown option '$arg'" >&2; exit 1 ;;
	esac
done

case "$method" in
	https)
		ipv4=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://checkip.amazonaws.com 2>/dev/null)
		ipv6=$(curl -s https://api64.ipify.org 2>/dev/null)

		if [ -z "$ipv4" ] && [ -z "$ipv6" ]; then
			echo "Error: Could not get external IP address" >&2
			exit 1
		fi

		[ "$ipv6_only" != true ] && [ -n "$ipv4" ] && echo "$ipv4"
		[ "$ipv4_only" != true ] && [ -n "$ipv6" ] && echo "$ipv6"
		exit 0
		;;
	http)
		ipv4=$(curl -s http://whatismyip.akamai.com 2>/dev/null)

		if [ -z "$ipv4" ]; then
			echo "Error: Could not get external IP address" >&2
			exit 1
		fi

		echo "$ipv4"
		exit 0
		;;
	dns)
		ipv4=$(dig +short myip.opendns.com @resolver1.opendns.com 2>/dev/null)
		ipv6=$(dig +short myip.opendns.com AAAA @resolver1.opendns.com 2>/dev/null | grep -v "^;")

		if [ -z "$ipv4" ] && [ -z "$ipv6" ]; then
			echo "Error: Could not get external IP address via DNS" >&2
			exit 1
		fi

		[ "$ipv6_only" != true ] && [ -n "$ipv4" ] && echo "$ipv4"
		[ "$ipv4_only" != true ] && [ -n "$ipv6" ] && echo "$ipv6"
		exit 0
		;;
esac

