#!/bin/sh

# get external IP addresses (IPv4 and IPv6)
# used for outgoing Internet connections

case "$1" in
	-h|--help)
		cat << 'EOF'
Usage: ip-address-internet [METHOD]

Print external IP addresses

Methods:
  https   HTTPS queries (default)
  http    HTTP queries
  dns     DNS queries via OpenDNS
  -h, --help  Show this help
EOF
		exit 0
		;;
	""|https)
		ipv4=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://checkip.amazonaws.com 2>/dev/null)
		ipv6=$(curl -s https://api64.ipify.org 2>/dev/null)

		if [ -z "$ipv4" ] && [ -z "$ipv6" ]; then
			echo "Error: Could not get external IP address" >&2
			exit 1
		fi

		[ -n "$ipv4" ] && echo "$ipv4"
		[ -n "$ipv6" ] && echo "$ipv6"
		exit 0
		;;
	http)
		ipv4=$(curl -s http://whatismyip.akamai.com 2>/dev/null)

		if [ -z "$ipv4" ]; then
			echo "Error: Could not get external IP address" >&2
			exit 1
		fi

		echo "$ipv4"
		exit 0
		;;
	dns)
		ipv4=$(dig +short myip.opendns.com @resolver1.opendns.com 2>/dev/null)
		ipv6=$(dig +short myip.opendns.com AAAA @resolver1.opendns.com 2>/dev/null | grep -v "^;")

		if [ -z "$ipv4" ] && [ -z "$ipv6" ]; then
			echo "Error: Could not get external IP address via DNS" >&2
			exit 1
		fi

		[ -n "$ipv4" ] && echo "$ipv4"
		[ -n "$ipv6" ] && echo "$ipv6"
		exit 0
		;;
	*)
		echo "Error: Unknown option '$1'" >&2
		echo "Use -h or --help for usage" >&2
		exit 1
		;;
esac

