#!/usr/bin/env zsh -e
#   ~/.dotfiles/.aliases

autoload -Uz bin-abort ba-err echoer

function alias-compdef() {
  local toalias=$1
  local prog="$2"
  local args="$3"
  local aliasto="$prog"
  if [[ $# = 3 ]]; then
    alias   $toalias="$aliasto $args"
    compdef $toalias="$aliasto"
  elif [[ $# = 2 ]]; then
    alias   $toalias="$aliasto"
    compdef $toalias="$aliasto"
  else
    ba-err 12 '' "\$${0:t}" 'bad arguments'
    echoer 'wrong number of args'
    echoer 'you need three alias, statement, statement_args'
  fi
}

function aliasof() {
  local a1=$(alias "$1")
  [[ $a1 == "" ]] && return 1
  echo "$a1" | \grep -qo "^${1}='.*'"
  [[ $? == "0" ]] \
    && echo "$a1" | \sed -E "s|^${1}='(.+)'$|\1|" \
    || echo "$a1" | \sed -E "s|^${1}=(.+)$|\1|"
}


alias rm='trash'

alias-compdef vim "$EDITOR"
alias-compdef  vi "$EDITOR"
alias-compdef   v "$EDITOR"

if [[ "$OSX" == "$TRUE" ]]; then
  alias-compdef python python3
  alias-compdef    pip pip3
fi
#[[ "$OSX" == "$TRUE" ]] \
    #&& alias python="python3.6.9" \
    #|| alias python3="python3.7.4"

alias-compdef    zshrc "$EDITOR" "$ZDOTDIR/.zshrc"
alias-compdef   zshenv "$EDITOR" "$ZDOTDIR/.zshenv"
alias-compdef   zlogin "$EDITOR" "$ZDOTDIR/.zlogin"
alias-compdef zprofile "$EDITOR" "$ZDOTDIR/.zprofile"
alias-compdef    vimrc "$EDITOR" "${DOTFILES:-$HOME}/.vim/vimrc"

if command_exists zshz; then
  compdef _zshz z=zshz
fi

#alias-compdef ql 'quick-look'

function() { # ls
  local  LSPRG_PRG='ls'
  local LSPRG_ARGS=' -LhHGstc'

  if command_exists gls; then
    #local LSPRG_PRG="`which -p gls ls | head -n1 | xargs basename`"
    #if [[ "$LSPRG_PRG" == 'gls' ]]; then echo 'has gls'; fi
    local GLSPRG_PRG='gls'
    local GLSPRG_ARGS="`
      printf ' -LhHGstc'
      printf ' --color=auto'
      printf ' --group-directories-first'
      printf ' --quoting-style=shell-always' `"
    alias-compdef gls "$GLSPRG_PRG" "$GLSPRG_ARGS"
    LSPRG_PRG="$GLSPRG_PRG"
    LSPRG_ARGS="$GLSPRG_ARGS"
  fi

  if command_exists lsd; then
    unalias lsd 2>/dev/null
    local LSDPRG_PRG='lsd'
    local LSDPRG_ARGS="`
    printf ' --blocks=date,size,user,name'
    printf ' --human-readable --size=short'
    printf ' --timesort --date=relative --reverse'
    printf ' --group-dirs=first --classify' `"
    alias lsd="${LSDPRG_PRG} ${LSDPRG_ARGS}"
    LSPRG_PRG="$LSDPRG_PRG"
    LSPRG_ARGS="$LSDPRG_ARGS"
  fi

  alias ls="\\$LSPRG_PRG $LSPRG_ARGS"
  alias-compdef l   'gls'         '-1'
  alias-compdef ll  'gls'         '-1l'
  alias la='nowrap   gls'; compdef la=ls
  alias-compdef lt  'gls'         '-1Al --tree --depth=2'
}

alias   sudo='nocorrect sudo -E '
compdef sudo=sudo

alias-compdef   s 'sudo'

alias-compdef llog 'command' '-p log'

alias-compdef .. 'cd' '..'
alias-compdef ... 'cd' '../..'

#alias-compdef less  "$PAGER"
#alias-compdef zless "$PAGER"

alias-compdef htop 'htop' '-u $USER'

_grep_prg=$(echo "${GREPPRG:-grep}" | cut -d' ' -f1)
if command_exists rg; then
  alias-compdef    rg "$_grep_prg"
  alias-compdef   rgc "$_grep_prg" "-C=0"
  alias-compdef   rgf "$_grep_prg" "--files | rg"
  alias-compdef   rgg "$_grep_prg" "--glob"
  alias-compdef  grep "$_grep_prg"
fi

# pip2 install pygments
#alias pcat='pygmentize -O style=monokai -f 256 -g'
alias-compdef pcat 'pygmentize' '-O style=base16-default-dark -f 256 -g'
alias-compdef c 'pcat'

[[ "$OSX" == "$TRUE" ]] \
  && alias-compdef ping 'ping' '-C -c 3 -i 0.2 -W 5000 -t 5 -Q' \
  || alias-compdef ping 'ping' '-c 3'

alias-compdef fs 'du' '-shL'

alias-compdef idea "$EDITOR" '~/Dropbox/ideas.md'

alias colortest='~/.config/base16-shell/colortest'

function pyeve() { eval "`~/bin/pyeve ${1:-';'}`" }

#alias-compdef chmod 'command' '-p chmod'
#alias-compdef chown 'command' '-p chown'
#alias-compdef chgrp 'command' '-p chgrp'


alias-compdef info 'command' '-p info --vi-keys'

function ifs-reset() {
  local _ifs_default=$'\ \t\n\0'
  if [[ ! $IFS = $_ifs_default ]]; then
    printf '👴🏽 _old_ IFS=%q\n' "$IFS"
    IFS=$_ifs_default
    printf '👶🏽 ~new~ IFS=%q\n' "$IFS"
  fi
  echo '✅ IFS reset!'
}

# shell output line wrapping
alias-compdef wrapoff 'tput' 'rmam'
alias-compdef  wrapon 'tput' 'smam'
function nowrap() {
  [ -t 1 ] && tput rmam
  "$@"; local ret="$?"
  [ -t 1 ] && tput smam
  return "$ret"
}
alias nowrap='nowrap '


# git
alias-compdef gc  'git'  'commit'
alias-compdef gca 'git' 'commit -a'
alias-compdef  gd 'git' 'diff'
alias-compdef gdd 'git' 'diff --color-words'
alias-compdef gl  'git'  'log'
alias-compdef gp  'git'  'push'
alias-compdef grv 'git' 'remote -v'
alias-compdef gst 'git' 'status'
alias-compdef ga  'git'  'add'
alias-compdef gco 'git' 'checkout'
alias-compdef gcm 'git' 'checkout master'

alias ghclone='cd "$(git gh `pbpaste | tr "'"/"'" "'"  "'"`)" && :'


function ghq-get() {
  local x="$(
    if [[ ${OSX:-0} == ${TRUE:-1} ]]; then
      pbpaste
    elif [[ ${LINUX:-0} == ${TRUE:-1} ]]; then
      xclip -out
    fi)"
  ghq get -u -p --shallow "$x" 1>&2
  echo "$(ghq root)/$(ghq list "$x")"
}
alias get='cd "$(ghq-get)"'

function tree() {
  #-D -c \
  /usr/bin/env tree \
    --du \
    --filelimit 512 \
    --prune \
    -F -L 4 \
    -h \
    -I "node_modules|bower_components|vendor|bundle|target|build|public|.git" \
    "$@"
}
#alias tree='tree --du --si --filelimit 512 -I "node_modules|bower_components|vendor|bundle|target|build|public|.git" -L 5'

alias phpcs='phpcs --standard=ruleset.xml --extensions=php --ignore=node_modules,bower_components,vendor -n -s'


function echoer() {
  printf "%s\n" "$*" >&2;
}


function gencomp_all() {
  for p in $path; do command -p ls $p; done |\
    uniq |\
    { while read c; do gencomp $c; done }
}


function trnl() {
    tr "${1:-':'}" '\n'
}

function mktempf() {
    fpref="${DOTFILES_PACKAGE:-"$USER"_`basename $SHELL`}"
    tempf="${fpref}.${1:-$0}.XXXX"
    mktemp -t "${tempf}" 2>/dev/null || (
        read -d '' errmsg<<-"EOF"
			%s - error
			    \$TMPDIR = "%s"
			    \$tempf  = "%s"
		EOF
        echo "$0" "$TMPDIR" "$tempf" | echoer
    )
}

function ppvar() {
    local tempf=`mktempf`
    exec 3>&2 2>$tempf
    local var_name=`echo "${1:-PATH}" | tr -d '$'`
    echoer "$0"' - pretty print env vars'
    echoer $'\tvar name\t-> '"$var_name"''
    local plines=$(eval echo \${$var_name} | trnl "${2:-':'}")
    echoer $'\titem count\t-> '"$(echo "$plines" | wc -l | xargs)"
    echo "$plines"
    exec 2>&3 3>&-
    xargs -0 printf '\n%s\n' >&2 < $tempf
}


function npm-do {
    (PATH=$(npm bin):$PATH; eval $@;)
}


# pyenv
function gpip()  {PIP_REQUIRE_VIRTUALENV='' pip  "$@"}
function gpip2() {PIP_REQUIRE_VIRTUALENV='' pip2 "$@"}
function gpip3() {PIP_REQUIRE_VIRTUALENV='' pip3 "$@"}

alias pyenv-init='eval "$(pyenv init -)"; eval "$(pyenv virtualenv-init -)"'
